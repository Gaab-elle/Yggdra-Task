<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Frontend - Laravel Echo</title>
    <script src="https://js.pusher.com/8.2.0/pusher.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/laravel-echo@1.15.3/dist/echo.iife.js"></script>
</head>
<body>
    <h1>üß™ Teste do Laravel Echo</h1>
    
    <div id="status">
        <h2>Status do Sistema</h2>
        <div id="echo-status">Carregando...</div>
        <div id="pusher-status">Carregando...</div>
        <div id="connection-status">Carregando...</div>
    </div>
    
    <div id="test-section">
        <h2>Teste de Conex√£o</h2>
        <button onclick="testConnection()">Testar Conex√£o</button>
        <button onclick="testChannel()">Testar Canal</button>
        <div id="test-results"></div>
    </div>
    
    <div id="logs">
        <h2>Logs</h2>
        <div id="log-content"></div>
    </div>

    <script>
        // Configura√ß√£o do Laravel Echo
        const pusherKey = '661cf3c78faa86d8e332';
        const pusherCluster = 'sa1';
        
        console.log('üîß Configurando Laravel Echo...');
        console.log('üîë Pusher Key:', pusherKey);
        console.log('üåê Pusher Cluster:', pusherCluster);
        
        // Configurar Pusher
        window.Pusher = Pusher;
        
        // Configurar Echo
        window.Echo = new Echo({
            broadcaster: 'pusher',
            key: pusherKey,
            cluster: pusherCluster,
            forceTLS: true,
            encrypted: true,
            authorizer: (channel, options) => {
                return {
                    authorize: (socketId, callback) => {
                        console.log('üîê Autenticando canal:', channel.name);
                        
                        // Para teste, vamos simular autentica√ß√£o
                        // Em produ√ß√£o, isso seria uma chamada para /broadcasting/auth
                        callback(null, {
                            auth: 'fake_auth_token_for_testing'
                        });
                    }
                };
            }
        });
        
        // Verificar status
        function updateStatus() {
            const echoStatus = document.getElementById('echo-status');
            const pusherStatus = document.getElementById('pusher-status');
            const connectionStatus = document.getElementById('connection-status');
            
            if (window.Echo) {
                echoStatus.innerHTML = '‚úÖ Laravel Echo: Carregado';
                echoStatus.style.color = 'green';
            } else {
                echoStatus.innerHTML = '‚ùå Laravel Echo: N√£o carregado';
                echoStatus.style.color = 'red';
            }
            
            if (window.Pusher) {
                pusherStatus.innerHTML = '‚úÖ Pusher: Carregado';
                pusherStatus.style.color = 'green';
            } else {
                pusherStatus.innerHTML = '‚ùå Pusher: N√£o carregado';
                pusherStatus.style.color = 'red';
            }
            
            if (window.Echo && window.Pusher) {
                connectionStatus.innerHTML = '‚úÖ Conex√£o: Pronta para teste';
                connectionStatus.style.color = 'green';
            } else {
                connectionStatus.innerHTML = '‚ùå Conex√£o: N√£o configurada';
                connectionStatus.style.color = 'red';
            }
        }
        
        // Testar conex√£o
        function testConnection() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<p>üîÑ Testando conex√£o...</p>';
            
            try {
                if (window.Echo) {
                    // Testar conex√£o com canal p√∫blico
                    const channel = window.Echo.channel('test-channel');
                    
                    channel.subscribed(() => {
                        results.innerHTML = '<p>‚úÖ Conex√£o bem-sucedida!</p>';
                        addLog('‚úÖ Conex√£o com canal p√∫blico estabelecida');
                        
                        // Testar evento
                        channel.listen('.test-event', (data) => {
                            addLog('üéâ Evento recebido: ' + JSON.stringify(data));
                        });
                        
                        // Emitir evento de teste
                        setTimeout(() => {
                            channel.whisper('test-event', { message: 'Teste de conex√£o' });
                            addLog('üì° Evento de teste enviado');
                        }, 1000);
                    });
                    
                    channel.error((error) => {
                        results.innerHTML = '<p>‚ùå Erro na conex√£o: ' + error.message + '</p>';
                        addLog('‚ùå Erro na conex√£o: ' + error.message);
                    });
                } else {
                    results.innerHTML = '<p>‚ùå Laravel Echo n√£o est√° dispon√≠vel</p>';
                    addLog('‚ùå Laravel Echo n√£o est√° dispon√≠vel');
                }
            } catch (error) {
                results.innerHTML = '<p>‚ùå Erro: ' + error.message + '</p>';
                addLog('‚ùå Erro no teste: ' + error.message);
            }
        }
        
        // Testar canal privado
        function testChannel() {
            const results = document.getElementById('test-results');
            results.innerHTML = '<p>üîÑ Testando canal privado...</p>';
            
            try {
                if (window.Echo) {
                    // Simular usu√°rio ID 2 (como no teste anterior)
                    const channel = window.Echo.private('user.2');
                    
                    channel.subscribed(() => {
                        results.innerHTML = '<p>‚úÖ Canal privado conectado!</p>';
                        addLog('‚úÖ Conectado ao canal privado: user.2');
                        
                        // Escutar evento de tarefa atribu√≠da
                        channel.listen('.task.assigned', (data) => {
                            addLog('üéâ Tarefa atribu√≠da recebida: ' + JSON.stringify(data));
                            results.innerHTML = '<p>üéâ Notifica√ß√£o recebida!</p>';
                        });
                    });
                    
                    channel.error((error) => {
                        results.innerHTML = '<p>‚ùå Erro no canal privado: ' + error.message + '</p>';
                        addLog('‚ùå Erro no canal privado: ' + error.message);
                    });
                } else {
                    results.innerHTML = '<p>‚ùå Laravel Echo n√£o est√° dispon√≠vel</p>';
                    addLog('‚ùå Laravel Echo n√£o est√° dispon√≠vel');
                }
            } catch (error) {
                results.innerHTML = '<p>‚ùå Erro: ' + error.message + '</p>';
                addLog('‚ùå Erro no teste: ' + error.message);
            }
        }
        
        // Adicionar log
        function addLog(message) {
            const logContent = document.getElementById('log-content');
            const timestamp = new Date().toLocaleTimeString();
            logContent.innerHTML += `<p>[${timestamp}] ${message}</p>`;
            console.log(`[${timestamp}] ${message}`);
        }
        
        // Inicializar
        window.addEventListener('load', () => {
            updateStatus();
            addLog('üöÄ P√°gina carregada, sistema inicializado');
            
            // Verificar se tudo est√° funcionando
            setTimeout(() => {
                if (window.Echo && window.Pusher) {
                    addLog('‚úÖ Sistema pronto para testes');
                } else {
                    addLog('‚ùå Sistema n√£o configurado corretamente');
                }
            }, 1000);
        });
    </script>
</body>
</html> 